<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .container { width: 90%; margin: 50px auto; }
        .header { display: flex; justify-content: space-between; align-items: center; }
        .header h2 { margin: 0; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { padding: 10px; border: 1px solid #ddd; }
        th { background-color: #f4f4f4; }
        .form-group { margin-bottom: 15px; }
        label { display: block; }
        input, select { width: 100%; padding: 8px; }
        button { padding: 10px; background-color: #007BFF; color: white; border: none; cursor: pointer; }
        button.edit { background-color: #28a745; }
        button.delete { background-color: #dc3545; }
        .hidden { display: none; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h2>Admin Dashboard</h2>
        <button id="logoutButton">Logout</button>
    </div>
    <div id="userManagementSection">
        <h2>User Management</h2>
        <form id="userForm">
            <input type="hidden" id="userId">
            <div class="form-group">
                <label for="userName">Name:</label>
                <input type="text" id="userName" required>
            </div>
            <div class="form-group">
                <label for="userEmail">Email:</label>
                <input type="email" id="userEmail" required>
            </div>
            <div class="form-group">
                <label for="userPassword">Password:</label>
                <input type="password" id="userPassword">
            </div>
            <div class="form-group">
                <label for="userRole">Role:</label>
                <select id="userRole" required>
                    <option value="customer">Customer</option>
                    <option value="support">Support</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <button type="submit">Save User</button>
        </form>
        <h3>Users List</h3>
        <table>
            <thead>
            <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody id="usersTable">
            <!-- Users will be loaded here -->
            </tbody>
        </table>
    </div>

    <h2>Ticket Management</h2>
    <form id="ticketForm">
        <input type="hidden" id="ticketId">
        <div class="form-group">
            <label for="ticketTitle">Title:</label>
            <input type="text" id="ticketTitle" required>
        </div>
        <div class="form-group">
            <label for="ticketDescription">Description:</label>
            <input type="text" id="ticketDescription" required>
        </div>
        <div class="form-group">
            <label for="ticketStatus">Status:</label>
            <select id="ticketStatus" required>
                <option value="open">Open</option>
                <option value="in_progress">In Progress</option>
                <option value="closed">Closed</option>
            </select>
        </div>
        <div class="form-group">
            <label for="ticketAssignedTo">Assigned To:</label>
            <select id="ticketAssignedTo">
                <option value="">Unassigned</option>
            </select>
        </div>
        <button type="submit">Save Ticket</button>
    </form>
    <h3>Tickets List</h3>
    <table>
        <thead>
        <tr>
            <th>Title</th>
            <th>Description</th>
            <th>Status</th>
            <th>Assigned To</th>
            <th>Created By</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="ticketsTable">
        <!-- Tickets will be loaded here -->
        </tbody>
    </table>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const userForm = document.getElementById('userForm');
        const usersTable = document.getElementById('usersTable');
        const ticketsTable = document.getElementById('ticketsTable');
        const userIdInput = document.getElementById('userId');
        const userNameInput = document.getElementById('userName');
        const userEmailInput = document.getElementById('userEmail');
        const userPasswordInput = document.getElementById('userPassword');
        const userRoleInput = document.getElementById('userRole');

        const ticketForm = document.getElementById('ticketForm');
        const ticketIdInput = document.getElementById('ticketId');
        const ticketTitleInput = document.getElementById('ticketTitle');
        const ticketDescriptionInput = document.getElementById('ticketDescription');
        const ticketStatusInput = document.getElementById('ticketStatus');
        const ticketAssignedToInput = document.getElementById('ticketAssignedTo');



        // Fetch users and populate table
        async function fetchUsers() {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/users', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const users = await response.json();
            if (users.success) {
                usersTable.innerHTML = users.data.map(user => `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.role}</td>
                        <td>
                            <button class="edit" onclick="editUser('${user._id}')">Edit</button>
                            <button class="delete" onclick="deleteUser('${user._id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
                users.data.forEach(user => {
                    if (user.role === 'admin') {
                        ticketAssignedToInput.innerHTML += `<option value="${user._id}">${user.name}</option>`;
                    }
                });
            } else {
                console.error('Failed to fetch users:', users.message);
            }
        }

        // Fetch tickets and populate table
        async function fetchTickets() {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/tickets', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const tickets = await response.json();
            console.log('Fetched tickets:', tickets); // Log the fetched tickets
            if (tickets.success && Array.isArray(tickets.tickets)) {
                ticketsTable.innerHTML = tickets.tickets.map(ticket => `
            <tr>
                <td>${ticket.title}</td>
                <td>${ticket.description}</td>
                <td>${ticket.status}</td>
                <td>${ticket.assignedTo ? ticket.assignedTo.name : ''}</td>
                <td>${ticket.createdBy ? ticket.createdBy.name : ''}</td>
                <td>
                    <button class="edit" onclick="editTicket('${ticket._id}')">Edit</button>
                    <button class="delete" onclick="deleteTicket('${ticket._id}')">Delete</button>
                </td>
            </tr>
        `).join('');
            } else {
                console.error('Failed to fetch tickets or no tickets available:', tickets.message);
            }
        }


        // Function to edit a ticket
        window.editTicket = async function (id) {
            console.log(`Editing ticket with ID: ${id}`); // Log the ticket ID being edited
            const token = localStorage.getItem('token');
            const response = await fetch(`/api/tickets/${id}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const ticket = await response.json();
            if (ticket.success) {
                console.log('Ticket to edit:', ticket); // Log the ticket to be edited
                ticketIdInput.value = ticket.data._id;
                ticketTitleInput.value = ticket.data.title;
                ticketDescriptionInput.value = ticket.data.description;
                ticketStatusInput.value = ticket.data.status;
                ticketAssignedToInput.value = ticket.data.assignedTo ? ticket.data.assignedTo._id : '';
            } else {
                console.error('Failed to fetch ticket:', ticket.message);
            }
        };

        // Form submission for creating or updating user
        userForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            const id = userIdInput.value;
            const name = userNameInput.value;
            const email = userEmailInput.value;
            const password = userPasswordInput.value;
            const role = userRoleInput.value;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/users/${id}` : '/api/users';
            const token = localStorage.getItem('token');
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ name, email, password, role })
            });
            const data = await response.json();
            if (data.success) {
                alert('User saved successfully');
                userForm.reset();
                fetchUsers();
            } else {
                alert('Error: ' + data.message);
            }
        });

        // Edit user function
        window.editUser = async function (id) {
            const token = localStorage.getItem('token');
            const response = await fetch(`/api/users/${id}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const user = await response.json();
            if (user.success) {
                userIdInput.value = user.data._id;
                userNameInput.value = user.data.name;
                userEmailInput.value = user.data.email;
                userPasswordInput.value = '';
                userRoleInput.value = user.data.role;
            } else {
                console.error('Failed to fetch user:', user.message);
            }
        };

        // Function to delete a user
        window.deleteUser = async function (id) {
            if (confirm('Are you sure you want to delete this user?')) {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/users/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                if (data.success) {
                    alert('User deleted successfully');
                    fetchUsers();
                } else {
                    alert('Error: ' + data.message);
                }
            }
        };

        // Form submission for creating or updating ticket
        ticketForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            const id = ticketIdInput.value;
            const title = ticketTitleInput.value;
            const description = ticketDescriptionInput.value;
            const status = ticketStatusInput.value;
            const assignedTo = ticketAssignedToInput.value;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/tickets/${id}` : '/api/tickets';
            const token = localStorage.getItem('token');
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ title, description, status, assignedTo })
            });
            const data = await response.json();
            if (data.success) {
                alert('Ticket saved successfully');
                ticketForm.reset();
                fetchTickets();
            } else {
                alert('Error: ' + data.message);
            }
        });

        // Function to delete a ticket
        window.deleteTicket = async function (id) {
            if (confirm('Are you sure you want to delete this ticket?')) {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/tickets/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                if (data.success) {
                    alert('Ticket deleted successfully');
                    fetchTickets();
                } else {
                    alert('Error: ' + data.message);
                }
            }
        };

        // Logout function
        document.getElementById('logoutButton').addEventListener('click', function () {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        });

        // Initial fetch of users and tickets
        fetchUsers();
        fetchTickets();
    });
</script>
</body>
</html>
