<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .container { width: 90%; margin: 50px auto; }
        .header { display: flex; justify-content: space-between; align-items: center; }
        .header h2 { margin: 0; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { padding: 10px; border: 1px solid #ddd; }
        th { background-color: #f4f4f4; }
        .form-group { margin-bottom: 15px; }
        label { display: block; }
        input, select { width: 100%; padding: 8px; }
        button { padding: 10px; background-color: #007BFF; color: white; border: none; cursor: pointer; }
        button.edit { background-color: #28a745; }
        button.delete { background-color: #dc3545; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h2>Customer Dashboard</h2>
        <button id="logoutButton">Logout</button>
    </div>
    <h2>Ticket Management</h2>
    <form id="ticketForm">
        <input type="hidden" id="ticketId">
        <div class="form-group">
            <label for="ticketTitle">Title:</label>
            <input type="text" id="ticketTitle" required>
        </div>
        <div class="form-group">
            <label for="ticketDescription">Description:</label>
            <input type="text" id="ticketDescription" required>
        </div>
        <div class="form-group">
            <label for="ticketStatus">Status:</label>
            <select id="ticketStatus" required>
                <option value="open">Open</option>
                <option value="in_progress">In Progress</option>
                <option value="closed">Closed</option>
            </select>
        </div>
        <button type="submit">Save Ticket</button>
    </form>
    <h3>Tickets List</h3>
    <table>
        <thead>
        <tr>
            <th>Title</th>
            <th>Description</th>
            <th>Status</th>
            <th>Assigned To</th>
            <th>Created By</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="ticketsTable">
        <!-- Tickets will be loaded here -->
        </tbody>
    </table>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        const ticketForm = document.getElementById('ticketForm');
        const ticketsTable = document.getElementById('ticketsTable');
        const ticketIdInput = document.getElementById('ticketId');
        const ticketTitleInput = document.getElementById('ticketTitle');
        const ticketDescriptionInput = document.getElementById('ticketDescription');
        const ticketStatusInput = document.getElementById('ticketStatus');

        // Fetch tickets and populate table
        async function fetchTickets() {
            const token = localStorage.getItem('token');
            const response = await fetch('/api/tickets', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const tickets = await response.json();
            console.log('Fetched tickets:', tickets); // Log the fetched tickets
            if (!tickets.success) {
                console.error('Failed to fetch tickets:', tickets.message);
                return;
            }
            if (tickets.tickets.length === 0) {
                console.log('No tickets found.');
                return;
            }
            // Filter tickets to only show those created by the current user
            const currentUserEmail = localStorage.getItem('email');
            const userTickets = tickets.tickets.filter(ticket => ticket.createdBy.email === currentUserEmail);
            ticketsTable.innerHTML = userTickets.map(ticket => `
                    <tr>
                        <td>${ticket.title}</td>
                        <td>${ticket.description}</td>
                        <td>${ticket.status}</td>
                        <td>${ticket.assignedTo ? ticket.assignedTo.name : ''}</td>
                        <td>${ticket.createdBy.name}</td>
                        <td>
                            <button class="edit" onclick="editTicket('${ticket._id}')">Edit</button>
                            <button class="delete" onclick="deleteTicket('${ticket._id}')">Delete</button>
                        </td>
                    </tr>
                `).join('');
        }

        // Edit ticket
        window.editTicket = async function (id) {
            console.log(`Editing ticket with ID: ${id}`); // Log the ticket ID being edited
            const token = localStorage.getItem('token');
            const response = await fetch(`/api/tickets/${id}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const ticket = await response.json();
            console.log('Ticket to edit:', ticket); // Log the ticket to be edited
            ticketIdInput.value = ticket.ticket._id;
            ticketTitleInput.value = ticket.ticket.title;
            ticketDescriptionInput.value = ticket.ticket.description;
            ticketStatusInput.value = ticket.ticket.status;
        };

        // Form submission for creating or updating ticket
        ticketForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            const id = ticketIdInput.value;
            const title = ticketTitleInput.value;
            const description = ticketDescriptionInput.value;
            const status = ticketStatusInput.value;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/tickets/${id}` : '/api/tickets';
            const token = localStorage.getItem('token');
            const response = await fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ title, description, status })
            });
            const data = await response.json();
            if (data.success) {
                alert('Ticket saved successfully');
                ticketForm.reset();
                fetchTickets();
            } else {
                alert('Error: ' + data.message);
            }
        });

        // Delete ticket
        window.deleteTicket = async function (id) {
            if (confirm('Are you sure you want to delete this ticket?')) {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/tickets/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                if (data.success) {
                    alert('Ticket deleted successfully');
                    fetchTickets();
                } else {
                    alert('Error: ' + data.message);
                }
            }
        };

        // Logout
        document.getElementById('logoutButton').addEventListener('click', function () {
            localStorage.removeItem('token');
            window.location.href = '/login.html';
        });

        // Initial fetch of tickets
        fetchTickets();
    });
</script>
</body>
</html>
